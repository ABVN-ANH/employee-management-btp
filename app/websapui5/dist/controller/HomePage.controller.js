sap.ui.define(["sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/resource/ResourceModel","sap/m/library","sap/m/Dialog","sap/m/Button","sap/m/Label","sap/m/Text","sap/m/MessageBox"],(e,t,o,n,s,i,l,r,a,h,c,d,g)=>{"use strict";const{DialogType:m,ButtonType:p}=r;function u(e){if(!e)return null;if(e instanceof Date){return e.toISOString().slice(0,10)}const t=new Date(e);if(!isNaN(t)){return t.toISOString().slice(0,10)}const o=e.match(/(\d{2}) ([A-Za-z]+), (\d{4})/);if(o){const[,e,t,n]=o;const s=new Date(`${t} 1, 2000`).getMonth()+1;return`${n}-${String(s).padStart(2,"0")}-${e}`}return e}function y(e){return e.getOwnerComponent().getModel("i18n").getResourceBundle()}function f(e,t){try{if(t.responseText){const e=JSON.parse(t.responseText);return e.error.message}}catch(e){}return t.message||y(e).getText("unknownError")}return t.extend("websapui5.controller.HomePage",{onInit:function(){this._formFragments={};this._oSelectedEmployeeContext=null;if(!this.getView().getModel("newEmployeeModel")){this.getView().setModel(new n({newEmployee:{firstName:"",lastName:"",dateOfBirth:null,gender:"",email:"",hireDate:null,department:{ID:""},role:{ID:""}}}),"newEmployeeModel")}this.getView().setModel(new n({selectedDepartment:"",selectedLevel:""}),"filterModel");this.getView().setModel(new n([{key:"Male",text:"Male"},{key:"Female",text:"Female"},{key:"Other",text:"Other"}]),"Genders");this.getView().setModel(new n({calculatedSalary:null,calculatedSalaryVisible:false}),"view");this.getView().setModel(this.getOwnerComponent().getModel("app"),"app");this._showFormFragment("List")},_setPageButtonStatus:function(e){const t=this.getView();t.byId("submit").setVisible(e)},onEmailLiveChange:function(e){const t=e.getSource();const o=t.getValue();const n=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o);t.setValueState(n?"None":"Error");t.setValueStateText(n?"":y(this).getText("invalidEmail"))},formatLevelState:function(e){const t={"Junior Specialist":"Indication15","Associate Expert":"Indication13",Specialist:"Indication05",Senior:"Indication07",Expert:"Indication02",Intern:"Indication12",Viewer:"Indication18",Admin:"Indication17"};return t[e]||"None"},createGroupHeader:function(e){return new sap.m.GroupHeaderListItem({title:e.key,upperCase:false})},onFilterChange:function(){this.applyTableFilters()},applyTableFilters:function(){const e=this.byId("employeeTable");if(!e)return;const t=e.getBinding("items");if(!t)return;const o=[];const n=this.byId("departmentFilter").getSelectedKey();const l=this.byId("levelFilter").getSelectedKey();if(n)o.push(new s("department/ID",i.EQ,n));if(l)o.push(new s("role/ID",i.EQ,l));t.filter(o)},handleEmployeeDetailsPress:function(e){const t=e.getSource().getBindingContext();this._oSelectedEmployeeContext=t;this._oSelectedEmployeeId=t.getObject().ID;this._showFormFragment("Display")},handleEmployeeListPress:function(){this._setPageButtonStatus(false);this._showFormFragment("List")},handleBackToListPress:function(){const e=this.getView().getModel("view");if(e){e.setProperty("/calculatedSalary",null);e.setProperty("/calculatedSalaryVisible",false)}this._showFormFragment("List")},handleCreateEmployeePress:function(){this.getView().getModel("newEmployeeModel").setProperty("/newEmployee",{firstName:"",lastName:"",dateOfBirth:null,gender:"",email:"",hireDate:null,department:{ID:""},role:{ID:""}});this._setPageButtonStatus(true);this._showFormFragment("Create")},handleEditEmployeePress:function(){this._setPageButtonStatus(false);this._showFormFragment("Change")},handleCancelPress:function(){const e=this.getView().getModel();if(this._oSelectedEmployeeContext&&e.hasPendingChanges()){e.resetChanges([this._oSelectedEmployeeContext.getPath()]);o.show(y(this).getText("{i18n>changesCancelled}"))}this._showFormFragment("Display")},handleSaveEmployeePress:function(){const e=this.getView().getModel();if(e.hasPendingChanges()){e.submitChanges({success:()=>{o.show(y(this).getText("{i18n>employeeUpdateSuccess}"));this._showFormFragment("Display")},error:e=>{const t=f(this,e);o.show(y(this).getText("{i18n>employeeUpdateError}",[t]));console.error("Update error:",e)}})}else{o.show(y(this).getText("{i18n>noChangesToSave}"));this._showFormFragment("Display")}},handleSubmitDialogPress:function(){if(!this.oSubmitDialog){this.oSubmitDialog=new a({type:m.Message,title:y(this).getText("{i18n>ctitle}"),content:[new c({text:y(this).getText("{i18n>ctext}")})],beginButton:new h({type:p.Emphasized,text:y(this).getText("{i18n>ok}"),press:()=>{this.oSubmitDialog.close();this.handleSubmitPress()}}),endButton:new h({type:p.Default,text:y(this).getText("{i18n>cancel}"),press:()=>{this.oSubmitDialog.close()}})});this.getView().addDependent(this.oSubmitDialog)}this.oSubmitDialog.open()},handleSubmitPress:function(){const e=this.getView().getModel();const t=this.getView().getModel("newEmployeeModel");if(!t){o.show(y(this).getText("{i18n>newEmployeeModelNotFound}"));console.error("{i18n>newEmployeeModelNotFound}");return}const n=t.getProperty("/newEmployee");if(!n.firstName||!n.lastName||!n.email||!n.gender||!n.dateOfBirth||!n.hireDate||!n.department||!n.department.ID||!n.role||!n.role.ID){o.show(y(this).getText("{i18n>missingRequiredFields}"));return}const s={firstName:n.firstName,lastName:n.lastName,dateOfBirth:u(n.dateOfBirth),gender:n.gender,email:n.email,hireDate:u(n.hireDate),department:{ID:n.department.ID},role:{ID:n.role.ID}};const i=e.bindList("/Employees");i.create(s).created().then(()=>{o.show(y(this).getText("{i18n>employeeCreated}"));this._refreshEmployeeTable();this._resetNewEmployeeForm();this._showFormFragment("List")}).catch(e=>{g.error(f(this,e))})},onSelectionChange:function(e){const t=e.getParameter("listItem")||e.getParameter("row");if(t){this._oSelectedEmployeeContext=t.getBindingContext();this._oSelectedEmployeeId=this._oSelectedEmployeeContext.getObject().ID}else{this._oSelectedEmployeeContext=null;this._oSelectedEmployeeId=null}},handleDeleteDialog:function(e){if(e&&e.getSource){var t=e.getSource().getBindingContext();if(t){this._oSelectedEmployeeContext=t}}if(!this.oDeleteDialog){this.oDeleteDialog=new a({type:m.Message,title:y(this).getText("{i18n>ctitle}"),content:[new c({text:y(this).getText("{i18n>dtext}")})],beginButton:new h({type:p.Emphasized,text:y(this).getText("{i18n>ok}"),press:()=>{this.oDeleteDialog.close();this.onDeleted()}}),endButton:new h({type:p.Default,text:y(this).getText("{i18n>cancle}"),press:()=>{this.oDeleteDialog.close()}})});this.getView().addDependent(this.oDeleteDialog)}this.oDeleteDialog.open()},onDeleted:function(){const e=this._oSelectedEmployeeContext;if(!e){o.show(y(this).getText("{i18n>noEmployeeSelected}"));console.warn("No employee context selected for deletion.");return}e.delete().then(()=>{o.show(y(this).getText("{i18n>employeeDeleteSuccess}"));this._refreshEmployeeTable();this._oSelectedEmployeeContext=null;this._showFormFragment&&this._showFormFragment("List")}).catch(e=>{const t=f(this,e)||"{i18n>deleteFailed}";o.show(y(this).getText("{i18n>deleteFailed}",[t]));console.error("{i18n>deleteFailed}",e)})},handleCalculateSalary:async function(){try{const e=this.getView();const t=e.getModel();if(!t){g.error(y(this).getText("{i18n>odataModelNotAvailable}"));return}const o=this._oSelectedEmployeeId;if(!o){g.error(y(this).getText("{i18n>noEmployeeSelected}"));return}const s=`/calculateEmployeeSalary(ID='${o}')`;const i=t.bindContext(s,null);const l=await i.requestObject();const r=l?.value;let a=e.getModel("view");if(!a){a=new n;e.setModel(a,"view")}a.setProperty("/calculatedSalary",r);a.setProperty("/calculatedSalaryVisible",true)}catch(e){let t="An unknown error occurred.";if(e&&e.message){t=e.message}else if(e&&e.responseText){try{const o=JSON.parse(e.responseText);t=o.error.message}catch(o){t="Error parsing server response: "+e.responseText}}g.error(y(this).getText("{i18n>errorCalculatingSalary}",[t]));console.error("{i18n>errorCalculatingSalary}",e)}},_refreshEmployeeTable:function(){const e=this.byId("employeeTable");if(e){const t=e.getBinding("items");if(t){t.refresh()}}},_resetNewEmployeeForm:function(){const e=this.getView().getModel("newEmployeeModel");if(e){e.setProperty("/newEmployee",{firstName:"",lastName:"",dateOfBirth:null,gender:"",email:"",hireDate:null,department:{ID:""},role:{ID:""}})}},_getFormFragment:function(t){const o=this.getView();if(!this._formFragments[t]){this._formFragments[t]=e.load({id:o.getId(),name:`websapui5.view.fragment.HomePage${t}`,controller:this})}return this._formFragments[t]},_showFormFragment:function(e){const t=this.byId("page");if(!t)return;t.removeAllContent();const n=this.getView().getModel("view");if(n){n.setProperty("/isCreateMode",e==="Create")}this.getView().setModel(this.getOwnerComponent().getModel("app"),"app");const s=this.getOwnerComponent().getModel("app").getProperty("/userRole");console.log("[DEBUG] userRole in app model:",s);this._getFormFragment(e).then(n=>{t.insertContent(n);if((e==="Display"||e==="Change")&&this._oSelectedEmployeeContext){const e=this._oSelectedEmployeeContext.getModel();let t=this._oSelectedEmployeeContext.getPath();const o=t.match(/\((.*?)\)/);if(o&&o[1]&&o[1].indexOf("'")===-1&&isNaN(o[1])){t=t.replace(`(${o[1]})`,`('${o[1]}')`)}n.setModel(e);n.bindElement(t)}else if((e==="Display"||e==="Change")&&!this._oSelectedEmployeeContext){o.show(y(this).getText("{i18n>noEmployeeSelected}"));this.handleBackToListPress()}if(e==="List"){this.applyTableFilters()}this._setPageButtonStatus(e==="Create"||e==="Change")}).catch(t=>{o.show(y(this).getText("fragmentLoadError",[e]));console.error(`Error loading fragment ${e}:`,t)})}})});
//# sourceMappingURL=HomePage.controller.js.map